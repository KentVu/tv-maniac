fastlane_version "2.68.0"

default_platform(:ios)

# Set timeout for xcodebuild commands
TEST_DEVICE = "iPhone 15 Pro (17.5)"
ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "180"
ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "5"

platform :ios do

  desc "Run Snapshot Tests"
  lane :snapshot_tests do
    # Clear derived data first for clean state
    clear_derived_data_lane

    gradle_tasks

    # Run SwiftUI Components snapshot tests
    run_tests(
      project: "ios/tv-maniac.xcodeproj",
      scheme: "SwiftUIComponents",
      device: TEST_DEVICE,
      clean: true,
      result_bundle: true,
      xcargs: "-retry-tests-on-failure",
      number_of_retries: 2,
      fail_build: true,
      derived_data_path: "derived_data"
    )

    # Run TvManiacUI snapshot tests
    run_tests(
      project: "ios/tv-maniac.xcodeproj",
      scheme: "TvManiacUI",
      device: TEST_DEVICE,
      clean: true,
      result_bundle: true,
      xcargs: "-retry-tests-on-failure",
      number_of_retries: 2,
      fail_build: true,
      derived_data_path: "derived_data"
    )
  end

  desc "Build iOS App"
  lane :build_tvmaniac do
    # Clear derived data first
    clear_derived_data_lane

    gradle_tasks

    # Resolve SPM packages first
    sh("cd ../ios && xcodebuild -resolvePackageDependencies -project tv-maniac.xcodeproj -scheme tv-maniac")


    # Build the app
    build_ios_app(
      project: "ios/tv-maniac.xcodeproj",
      scheme: "tv-maniac",
      configuration: "Debug",
      destination: "platform=iOS Simulator,name=#{TEST_DEVICE}",
      derived_data_path: "derived_data",
      xcargs: "-skipPackagePluginValidation -resolvePackageDependencies",
      output_directory: "build",
      output_name: "tv-maniac-debug",
      buildlog_path: "fastlane/logs",
      clean: true,
      skip_package_ipa: true,
      skip_archive: true,
      skip_codesigning: true
    )
  end

  desc "Clear derived data"
  lane :clear_derived_data_lane do
    clear_derived_data(
      derived_data_path: "derived_data"
    )
  end

  desc "Run gradle tasks"
  lane :gradle_tasks do
    gradle(tasks: [":shared:copyXCFramework"])
  end
end
